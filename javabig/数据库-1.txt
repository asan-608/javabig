-- 2. 用户表（新增 email、phone 均可空且不唯一）
CREATE TABLE users (
  user_id        BIGINT       PRIMARY KEY AUTO_INCREMENT,
  username       VARCHAR(50)  NOT NULL UNIQUE,
  password_hash  VARCHAR(255) NOT NULL,
  role           ENUM('admin','user') NOT NULL DEFAULT 'user',
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  email          VARCHAR(255) DEFAULT NULL COMMENT '用户邮箱',
  phone          VARCHAR(20)  DEFAULT NULL COMMENT '用户手机号'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. 题型表（单选/多选/填空/判断）
CREATE TABLE question_types (
  type_id  INT     PRIMARY KEY AUTO_INCREMENT,
  code     VARCHAR(20) NOT NULL UNIQUE,  -- e.g. 'single_choice'
  name     VARCHAR(20) NOT NULL           -- e.g. '单选题'
  score    INT    NOT NULL DEFAULT 0  COMMENT '本选项分值';
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. 难度等级表
CREATE TABLE difficulty_levels (
  difficulty_id INT    PRIMARY KEY AUTO_INCREMENT,
  name          VARCHAR(20) NOT NULL,     -- e.g. '简单'
  description   VARCHAR(100)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. 题库表
CREATE TABLE questions (
  question_id    BIGINT     PRIMARY KEY AUTO_INCREMENT,
  content        TEXT       NOT NULL,                    -- 题干
  type_id        INT        NOT NULL DEFAULT 1,           -- 题型
  difficulty_id  INT        NOT NULL DEFAULT 1,           -- 难度等级
  correct_answer TEXT,                                    -- 答案
  explanation    TEXT,                                    -- 答案解析
  created_by     BIGINT     NOT NULL,                    -- 出题者（用户）
  created_at     DATETIME   NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (type_id) REFERENCES question_types(type_id),
  FOREIGN KEY (difficulty_id) REFERENCES difficulty_levels(difficulty_id),
  FOREIGN KEY (created_by) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. 题目选项表（单选/多选题专用）
CREATE TABLE question_options (
  option_id   BIGINT    PRIMARY KEY AUTO_INCREMENT,
  question_id BIGINT    NOT NULL,
  content     TEXT      NOT NULL,                       -- 选项文本
  is_correct  BOOLEAN   NOT NULL DEFAULT FALSE,
  sequence    INT       NOT NULL DEFAULT 0,
  FOREIGN KEY (question_id) REFERENCES questions(question_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 7. 测验会话表
CREATE TABLE test_sessions (
  session_id  BIGINT    PRIMARY KEY AUTO_INCREMENT,
  user_id     BIGINT    NOT NULL,
  start_time  DATETIME  NOT NULL DEFAULT CURRENT_TIMESTAMP,
  end_time    DATETIME,
  total_score INT        DEFAULT 0,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 8. 会话-题目关联表
CREATE TABLE session_questions (
  session_q_id BIGINT    PRIMARY KEY AUTO_INCREMENT,
  session_id   BIGINT    NOT NULL,
  question_id  BIGINT    NOT NULL,
  sequence     INT       NOT NULL DEFAULT 0,           -- 出题顺序
  user_answer  TEXT,                                     -- 用户提交答案
  is_correct   BOOLEAN,
  FOREIGN KEY (session_id)   REFERENCES test_sessions(session_id),
  FOREIGN KEY (question_id)  REFERENCES questions(question_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 9. 错题本表
CREATE TABLE wrong_questions (
  wrong_id      BIGINT    PRIMARY KEY AUTO_INCREMENT,
  user_id       BIGINT    NOT NULL,
  question_id   BIGINT    NOT NULL,
  first_wrong_at DATETIME NOT NULL,
  last_wrong_at  DATETIME NOT NULL,
  wrong_count    INT      NOT NULL DEFAULT 1,
  FOREIGN KEY (user_id)     REFERENCES users(user_id),
  FOREIGN KEY (question_id) REFERENCES questions(question_id),
  UNIQUE KEY ux_user_question (user_id, question_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 10. 复习安排表
CREATE TABLE review_schedule (
  schedule_id   BIGINT    PRIMARY KEY AUTO_INCREMENT,
  wrong_id      BIGINT    NOT NULL,
  next_review_at DATETIME NOT NULL,
  interval_days  INT       NOT NULL DEFAULT 1,
  e_factor       FLOAT     NOT NULL DEFAULT 2.5,       -- SRS 记忆因子
  FOREIGN KEY (wrong_id) REFERENCES wrong_questions(wrong_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 11. 排行榜视图（实时查询）
CREATE VIEW leaderboard AS
SELECT 
  u.user_id,
  u.username,
  COUNT(s.session_id)      AS tests_taken,
  SUM(s.total_score)       AS total_score,
  ROUND(AVG(s.total_score),2) AS avg_score
FROM users u
LEFT JOIN test_sessions s ON u.user_id = s.user_id
GROUP BY u.user_id, u.username
ORDER BY total_score DESC;

-- 12. 试卷表：存储试卷信息
CREATE TABLE exam_papers (
  paper_id     BIGINT     PRIMARY KEY AUTO_INCREMENT,
  title        VARCHAR(255) NOT NULL COMMENT '试卷名称',
  description  TEXT        NULL COMMENT '试卷描述',
  created_by   BIGINT      NOT NULL COMMENT '出题者（用户）',
  created_at   DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at   DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES users(user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 13. 试卷-题目关联表：定义试卷包含哪些题，以及出题顺序
CREATE TABLE paper_questions (
  paper_q_id   BIGINT     PRIMARY KEY AUTO_INCREMENT,
  paper_id     BIGINT     NOT NULL COMMENT '试卷 ID',
  question_id  BIGINT     NOT NULL COMMENT '题目 ID',
  sequence     INT        NOT NULL DEFAULT 0 COMMENT '在试卷中的顺序',
  FOREIGN KEY (paper_id)    REFERENCES exam_papers(paper_id),
  FOREIGN KEY (question_id) REFERENCES questions(question_id),
  UNIQUE KEY ux_paper_question (paper_id, question_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 14. 考试成绩表：记录学生每份试卷的得分
CREATE TABLE exam_results (
  result_id  BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id    BIGINT NOT NULL,
  paper_id   BIGINT NOT NULL,
  score      INT    NOT NULL,
  taken_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (paper_id) REFERENCES exam_papers(paper_id),
  UNIQUE KEY ux_user_paper (user_id, paper_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;